<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TheMoneyOlympics - Levels</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            /* Light theme variables (default) */
            --bg-color: #f5f5f5;
            --header-bg: rgba(255, 255, 255, 0.3);
            --card-bg: rgba(255, 255, 255, 0.3);
            --text-color: #333333;
            --accent-color: #D4AF37;
            --border-radius: 12px;
            --border-color: rgba(0, 0, 0, 0.1);
            --overlay-bg: rgba(0, 0, 0, 0.5);
        }

        :root[data-theme="dark"] {
            /* Dark theme variables */
            --bg-color: #000000;
            --header-bg: rgba(64, 64, 64, 0.3);
            --card-bg: rgba(64, 64, 64, 0.3);
            --text-color: #ffffff;
            --accent-color: #D4AF37;
            --border-color: rgba(255, 255, 255, 0.1);
            --overlay-bg: rgba(0, 0, 0, 0.7);
        }

        body {
            background: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.5;
            transition: all 0.3s ease;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            padding-left: 0;
            background: var(--header-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
        }

        .logo {
            font-family: "Times New Roman", serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-color);
            line-height: 1;
            text-decoration: none;
            transition: color 0.3s ease, transform 0.2s ease;
            cursor: pointer;
            padding: 0 1.5rem;
            margin: 0;
            display: flex;
            align-items: center;
            height: 100%;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        [data-theme="dark"] .logo {
            color: #ffffff;
        }

        [data-theme="light"] .logo {
            color: #000000;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-controls button {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            padding: 0.5rem;
            font-size: 1.2rem;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }

        .header-controls button:hover {
            opacity: 1;
        }

        /* Add back button styling */
        .back-btn {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            padding: 0.5rem;
            font-size: 1.2rem;
            opacity: 0.8;
            transition: opacity 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: auto;
        }

        .back-btn:hover {
            opacity: 1;
            background: var(--card-bg);
        }

        .back-btn i {
            font-size: 1rem;
        }

        .main-content {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .journey-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3rem;
            padding: 0 1rem;
        }

        .journey-title {
            font-size: 2rem;
            font-weight: bold;
            margin: 0;
            color: var(--text-color);
        }

        .xp-counter {
            background: var(--card-bg);
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            font-weight: 500;
            color: var(--text-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .topics-container {
            display: flex;
            flex-direction: column;
            gap: 3rem;
            padding: 0 1rem;
        }

        .topic-container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .topic-header {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 2rem;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
        }

        .topic-header .level-content {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 1.5rem;
        }

        .topic-header .topic-icon {
            font-size: 2rem;
            opacity: 0.9;
        }

        .topic-header .topic-text {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .sub-levels-container {
            display: flex;
            flex-direction: column;
            gap: 3rem;
            position: relative;
            padding: 0 4rem;
        }

        .sub-level-card {
            width: 80px;
            height: 80px;
            background: var(--card-bg);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 2;
        }

        .sub-level-card:nth-child(odd) {
            align-self: flex-start;
            margin-left: 20%;
        }

        .sub-level-card:nth-child(even) {
            align-self: flex-end;
            margin-right: 20%;
        }

        .sub-level-card .level-icon {
            font-size: 1.5rem;
            color: var(--text-color);
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }

        .sub-level-card:hover .level-icon {
            opacity: 1;
        }

        .sub-level-card.completed {
            background: #58cc02;
            border-color: #4CAF50;
        }

        .sub-level-card.completed .level-icon {
            color: white;
            opacity: 1;
        }

        .sub-level-card.locked {
            background: var(--card-bg);
            opacity: 0.5;
        }

        .sub-level-card.locked .level-icon {
            opacity: 0.5;
        }

        .connecting-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .connecting-line path {
            stroke: var(--border-color);
            stroke-width: 2;
            fill: none;
            stroke-dasharray: 4 4;
        }

        .connecting-line path.completed {
            stroke: #58cc02;
            stroke-dasharray: none;
        }

        .level-tooltip {
            position: absolute;
            background: var(--card-bg);
            padding: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            width: 250px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 3;
        }

        .tooltip-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }

        .tooltip-overview {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            color: var(--text-color);
            opacity: 0.8;
        }

        .tooltip-xp {
            font-size: 0.8rem;
            color: var(--accent-color);
            margin-bottom: 0.5rem;
        }

        .start-lesson-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s ease;
        }

        .start-lesson-btn:hover {
            background: #b38f2d;
            transform: translateY(-2px);
        }

        .start-lesson-btn:active {
            transform: translateY(0);
        }

        .sub-level-card:hover .level-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .sub-level-card:nth-child(odd) .level-tooltip {
            left: 100px;
            top: 50%;
            transform: translateY(-50%);
        }

        .sub-level-card:nth-child(even) .level-tooltip {
            right: 100px;
            top: 50%;
            transform: translateY(-50%);
        }

        .topic-card {
            background: none !important;
            border: none !important;
            box-shadow: none !important;
            width: 100%;
            max-width: none;
            margin: 0;
            cursor: default;
            z-index: 3;
            position: relative;
            padding: 0;
            display: flex;
            align-items: center;
        }

        .level-card {
            background: none;
            border: none;
            border-radius: 0;
            width: 280px;
            height: auto;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
            cursor: pointer;
            z-index: 2;
            transition: transform 0.3s ease;
            box-shadow: none;
            margin: 0;
            color: var(--card-text-color);
        }

        .level-card::before {
            display: none;
        }

        /* Position cards on alternating sides */
        .level-card:nth-child(odd) {
            align-self: flex-start;
            margin-left: 50px;
        }

        .level-card:nth-child(even) {
            align-self: flex-end;
            margin-right: 50px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--overlay-bg);
            z-index: 100;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .modal-content {
            position: relative;
            background: var(--card-bg);
            margin: 15vh auto;
            padding: 2rem;
            width: 90%;
            max-width: 400px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-color);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }

        .close-btn:hover {
            opacity: 1;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .user-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .settings-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-option:last-child {
            border-bottom: none;
        }

        .settings-option select,
        .settings-option input[type="checkbox"] {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 0.5rem;
            border-radius: var(--border-radius);
        }

        .settings-option select {
            min-width: 120px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--card-bg);
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--accent-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">T</div>
        <div class="header-controls">
            <button class="profile-btn" onclick="showAccount()">
                <i class="fas fa-user"></i>
            </button>
            <button class="settings-btn" onclick="showSettings()">
                <i class="fas fa-cog"></i>
            </button>
            <button class="theme-btn" onclick="toggleTheme()">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </header>

    <main class="main-content">
        <div class="journey-header">
            <h1 class="journey-title">Your Financial Journey</h1>
            <div class="xp-counter">Total XP: <span id="totalXP">506</span></div>
        </div>

        <div class="topics-container" id="topicsContainer">
            <!-- Topics will be dynamically inserted here -->
        </div>
    </main>

    <!-- Account Modal -->
    <div id="accountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Your Account</h2>
                <button class="close-btn" onclick="closeModal('accountModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="user-info">
                    <div class="user-stat">
                        <span class="user-stat-label">Total XP:</span>
                        <span id="modalTotalXP">0</span>
                    </div>
                    <div class="user-stat">
                        <span class="user-stat-label">Current Level:</span>
                        <span id="modalCurrentLevel">1.1</span>
                    </div>
                    <div class="user-stat">
                        <span class="user-stat-label">Completed Levels:</span>
                        <span id="modalCompletedLevels">0</span>
                    </div>
                    <div class="user-stat">
                        <span class="user-stat-label">Next Level:</span>
                        <span id="modalNextLevel">50 XP needed</span>
                    </div>
                    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                        <button class="logout-btn" onclick="logout()" style="
                            background: var(--accent-color);
                            color: white;
                            border: none;
                            border-radius: 20px;
                            padding: 0.8rem 1.5rem;
                            font-size: 1rem;
                            cursor: pointer;
                            flex: 1;
                            transition: all 0.2s ease;
                        ">Log Out</button>
                        <a href="signup.html" style="
                            background: var(--card-bg);
                            color: var(--text-color);
                            border: 1px solid var(--border-color);
                            border-radius: 20px;
                            padding: 0.8rem 1.5rem;
                            font-size: 1rem;
                            cursor: pointer;
                            text-decoration: none;
                            text-align: center;
                            flex: 1;
                            transition: all 0.2s ease;
                        ">Create Account</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button class="close-btn" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-option">
                    <span>Dark Mode</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="theme-toggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="settings-option">
                    <span>Sound Effects</span>
                    <input type="checkbox" id="soundToggle" checked>
                </div>
                <div class="settings-option">
                    <span>Background Music</span>
                    <input type="checkbox" id="musicToggle" checked>
                </div>
                <div class="settings-option">
                    <span>Language</span>
                    <select id="languageSelect">
                        <option value="en">English</option>
                        <option value="es">Espa√±ol</option>
                        <option value="fr">Fran√ßais</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Load scripts at the end of body -->
    <script src="js/topics.js"></script>
    <script src="js/dailyStreakService.js"></script>
    <script>
        // Wait for both DOM and topics.js to be loaded
        window.addEventListener('load', function() {
            if (typeof window.topicsData === 'undefined') {
                console.error('Topics data not loaded!');
                return;
            }

            // Initialize daily streak service
            if (window.dailyStreakService) {
                window.dailyStreakService.initializeDailyStreak();
            }

            // Add function to check if a topic's exam is completed
            function isTopicExamCompleted(topicId) {
                const completedExams = JSON.parse(localStorage.getItem('completedExams') || '[]');
                console.log(`\n[Exam Check] Checking if topic ${topicId} exam is completed...`);
                console.log(`[Exam Check] Found ${completedExams.length} completed exams in storage:`, completedExams);
                
                const isCompleted = completedExams.some(exam => 
                    (typeof exam === 'object' && exam.topicId === topicId) || 
                    (typeof exam === 'number' && exam === topicId)
                );
                
                if (isCompleted) {
                    console.log(`[Exam Check] Topic ${topicId} exam is COMPLETED ‚úì`);
                } else {
                    console.log(`[Exam Check] Topic ${topicId} exam is NOT completed ‚úó`);
                }
                
                return isCompleted;
            }

            // Add function to check if a topic is locked
            function isTopicLocked(topicId, totalXP) {
                console.log(`\n[Topic Lock Check] Checking if topic ${topicId} is locked...`);
                console.log(`[Topic Lock Check] Current total XP: ${totalXP}`);
                
                if (topicId === 1) {
                    console.log('[Topic Lock Check] Topic 1 is always unlocked');
                    return false;
                }
                
                const previousTopic = window.topicsData[topicId - 2];
                if (!previousTopic) {
                    console.log('[Topic Lock Check] No previous topic found, unlocked by default');
                    return false;
                }
                
                const previousExam = previousTopic.subLevels.find(sub => sub.isExam);
                if (!previousExam) {
                    console.log('[Topic Lock Check] No exam found in previous topic, unlocked by default');
                    return false;
                }

                // Check XP requirement first
                const currentTopic = window.topicsData[topicId - 1];
                if (currentTopic) {
                    const minXPRequired = Math.min(...currentTopic.subLevels.map(sl => sl.xpRequired));
                    if (totalXP < minXPRequired) {
                        console.log(`[Topic Lock Check] Topic ${topicId} locked: Insufficient XP (have: ${totalXP}, need: ${minXPRequired})`);
                        return true;
                    }
                }
                
                const isExamCompleted = isTopicExamCompleted(topicId - 1);
                console.log(`[Topic Lock Check] Previous topic (${topicId - 1}) exam completion status:`, isExamCompleted);
                
                if (!isExamCompleted) {
                    console.log(`[Topic Lock Check] Topic ${topicId} locked: Previous topic's exam not completed`);
                    return true;
                }

                console.log(`[Topic Lock Check] Topic ${topicId} is unlocked! All criteria met.`);
                return false;
            }

            // Add function to mark exam as completed
            function markExamCompleted(topicId, score) {
                console.log(`[Debug] Marking exam for topic ${topicId} as completed`);
                const completedExams = JSON.parse(localStorage.getItem('completedExams') || '[]');
                
                // Remove any existing entry for this topic
                const existingIndex = completedExams.findIndex(exam => 
                    (typeof exam === 'object' && exam.topicId === topicId) || 
                    (typeof exam === 'number' && exam === topicId)
                );
                
                if (existingIndex !== -1) {
                    completedExams.splice(existingIndex, 1);
                }
                
                // Add new entry
                completedExams.push({ topicId, score: score || 100 });
                localStorage.setItem('completedExams', JSON.stringify(completedExams));
                
                // Force a re-render to update locked states
                console.log('[Debug] Forcing re-render of topics');
                renderTopics();
            }

            // Add function to check if a level has been completed
            function isLevelCompleted(topicId, subLevelId) {
                // Ensure proper formatting of IDs
                topicId = parseInt(topicId);
                subLevelId = parseFloat(subLevelId);
                
                console.log(`[Debug] Checking if level ${topicId}.${subLevelId} is completed`);
                
                const completedLevels = JSON.parse(localStorage.getItem('completedLevels') || '[]');
                const isCompleted = completedLevels.some(level => {
                    const storedTopicId = parseInt(level.topicId);
                    const storedSubLevelId = parseFloat(level.subLevelId);
                    return storedTopicId === topicId && storedSubLevelId === subLevelId;
                });
                
                console.log(`[Debug] Level ${topicId}.${subLevelId} completion status:`, isCompleted);
                return isCompleted;
            }

            // Theme toggle functionality
            const themeToggle = document.getElementById('theme-toggle');
            const themeBtn = document.querySelector('.theme-btn');
            const themeIcon = themeBtn.querySelector('i');
            const root = document.documentElement;

            // Function to update theme
            function updateTheme(isDark) {
                const theme = isDark ? 'dark' : 'light';
                root.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                
                // Update toggle switch state
                themeToggle.checked = isDark;
                
                // Update theme icon
                themeIcon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';

                // Update all theme-dependent elements
                document.querySelectorAll('.app-container, .top-bar, #question-container, .option-btn, #settings-panel, .modal-content, .topic-card, .sublevel-btn').forEach(element => {
                    element.style.transition = 'all 0.3s ease';
                });
            }

            // Initialize theme
            function initializeTheme() {
                const savedTheme = localStorage.getItem('theme') || 'light';
                updateTheme(savedTheme === 'dark');
            }

            // Initialize theme
            initializeTheme();

            // Theme toggle event listeners
            themeToggle.addEventListener('change', (e) => {
                updateTheme(e.target.checked);
            });

            // Add click handler for theme button
            themeBtn.addEventListener('click', () => {
                const isDark = root.getAttribute('data-theme') === 'dark';
                updateTheme(!isDark);
            });

            // Get XP from localStorage
            function getTotalXP() {
                return parseInt(localStorage.getItem('totalXP')) || 0;
            }

            // Update XP display
            function updateXPDisplay() {
                document.getElementById('totalXP').textContent = getTotalXP();
            }

            // Update the createConnectingLines function to handle progress
            function createConnectingLines(container, cards) {
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.classList.add('connecting-line');
                container.appendChild(svg);

                const totalXP = parseInt(localStorage.getItem('totalXP')) || 0;

                for (let i = 0; i < cards.length - 1; i++) {
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const start = cards[i].getBoundingClientRect();
                    const end = cards[i + 1].getBoundingClientRect();
                    const containerRect = container.getBoundingClientRect();

                    const startX = (start.left + start.right) / 2 - containerRect.left;
                    const startY = (start.top + start.bottom) / 2 - containerRect.top;
                    const endX = (end.left + end.right) / 2 - containerRect.left;
                    const endY = (end.top + end.bottom) / 2 - containerRect.top;

                    // Create curved path
                    const midY = (startY + endY) / 2;
                    const pathData = `M ${startX} ${startY} 
                                    C ${startX} ${midY},
                                      ${endX} ${midY},
                                      ${endX} ${endY}`;

                    path.setAttribute('d', pathData);

                    // Check if this path should be colored (completed)
                    const currentCard = cards[i];
                    const nextCard = cards[i + 1];
                    if (!currentCard.classList.contains('locked') && !nextCard.classList.contains('locked')) {
                        path.classList.add('completed');
                    }

                    svg.appendChild(path);
                }

                // Set SVG dimensions
                svg.setAttribute('width', '100%');
                svg.setAttribute('height', '100%');
            }

            // Modify the renderTopics function to add connecting lines
            function renderTopics() {
                const topicsContainer = document.getElementById('topicsContainer');
                if (!topicsContainer || !window.topicsData) return;

                topicsContainer.innerHTML = '';
                const totalXP = parseInt(localStorage.getItem('totalXP')) || 0;

                // Define topic emojis
                const topicEmojis = {
                    1: 'üè¶', // Basic Banking
                    2: 'üí≥', // Credit & Debt
                    3: 'üí∞', // Saving & Budgeting
                    4: 'üìà', // Investing
                    5: 'üè†', // Real Estate
                    6: 'üìä', // Financial Planning
                    7: 'üíº', // Career & Income
                    8: 'üåê', // Global Economics
                    9: 'üéì', // Advanced Finance
                    10: 'üöÄ' // Financial Independence
                };

                window.topicsData.forEach(topic => {
                    const topicContainer = document.createElement('div');
                    topicContainer.className = 'topic-container';

                    // Create topic header
                    const topicHeader = document.createElement('div');
                    topicHeader.className = 'topic-header';
                    topicHeader.innerHTML = `
                        <div class="level-content">
                            <div class="topic-icon">${topicEmojis[topic.id] || 'üìö'}</div>
                            <div class="topic-text">
                                <div class="topic-number">Topic ${topic.id}</div>
                                <div class="topic-title">${topic.title}</div>
                            </div>
                        </div>
                    `;

                    // Create sub-levels container
                    const subLevelsContainer = document.createElement('div');
                    subLevelsContainer.className = 'sub-levels-container';

                    // Create SVG for connecting lines
                    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                    svg.classList.add('connecting-line');
                    subLevelsContainer.appendChild(svg);

                    const subLevelCards = [];
                    topic.subLevels.forEach(subLevel => {
                        const subLevelCard = document.createElement('div');
                        const isLocked = totalXP < subLevel.xpRequired || isTopicLocked(topic.id, totalXP);
                        const isCompleted = isLevelCompleted(topic.id, subLevel.id);

                        subLevelCard.className = `sub-level-card ${isLocked ? 'locked' : ''} ${isCompleted ? 'completed' : ''} ${subLevel.isExam ? 'exam-card' : ''}`;

                        let tooltipContent = `
                            <div class="level-tooltip">
                                <div class="tooltip-title">${subLevel.title}</div>
                                <div class="tooltip-overview">${subLevel.overview || 'Learn about this topic'}</div>
                                <div class="tooltip-xp">XP Reward: ${subLevel.xpReward || 50}</div>
                                <button class="start-lesson-btn" style="display: none;">Start Lesson</button>
                        `;

                        if (isLocked) {
                            if (isTopicLocked(topic.id, totalXP)) {
                                tooltipContent += `<div class="tooltip-xp">Complete previous topic's exam first</div>`;
                            } else {
                                tooltipContent += `<div class="tooltip-xp">XP Required: ${subLevel.xpRequired}</div>`;
                            }
                        }

                        tooltipContent += `</div>`;

                        subLevelCard.innerHTML = `
                            <div class="level-icon">${isLocked ? 'üîí' : subLevel.isExam ? 'üìù' : 'üìö'}</div>
                            ${tooltipContent}
                        `;

                        if (!isLocked) {
                            const tooltip = subLevelCard.querySelector('.level-tooltip');
                            const startButton = tooltip.querySelector('.start-lesson-btn');
                            
                            // Show start button on hover
                            subLevelCard.addEventListener('mouseenter', () => {
                                startButton.style.display = 'block';
                            });
                            
                            // Hide start button when leaving
                            subLevelCard.addEventListener('mouseleave', () => {
                                startButton.style.display = 'none';
                            });

                            // Handle start button click
                            startButton.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const formattedSubLevelId = parseFloat(subLevel.id);
                                localStorage.setItem('currentLevel', JSON.stringify({
                                    topicId: topic.id,
                                    subLevelId: formattedSubLevelId,
                                    title: subLevel.title,
                                    isExam: subLevel.isExam
                                }));

                                // If this is an exam and it's completed, mark it as such
                                if (subLevel.isExam && isLevelCompleted(topic.id, formattedSubLevelId)) {
                                    const completedExams = JSON.parse(localStorage.getItem('completedExams') || '[]');
                                    if (!completedExams.includes(topic.id)) {
                                        completedExams.push(topic.id);
                                        localStorage.setItem('completedExams', JSON.stringify(completedExams));
                                        // Force a re-render to update locked states
                                        renderTopics();
                                    }
                                }

                                window.location.href = `index.html?topic=${topic.id}&sublevel=${formattedSubLevelId}`;
                            });
                        }

                        subLevelsContainer.appendChild(subLevelCard);
                        subLevelCards.push(subLevelCard);
                    });

                    // Create connecting lines
                    requestAnimationFrame(() => {
                        createConnectingLines(subLevelsContainer, subLevelCards);
                    });

                    topicContainer.appendChild(topicHeader);
                    topicContainer.appendChild(subLevelsContainer);
                    topicsContainer.appendChild(topicContainer);
                });
            }

            // Initialize everything
            updateXPDisplay();
            renderTopics();

            // Modal functions
            window.showAccount = function() {
                const modal = document.getElementById('accountModal');
                const totalXP = getTotalXP();
                
                document.getElementById('modalTotalXP').textContent = totalXP;
                
                let currentLevel = 1;
                let nextLevelXP = window.topicsData[0].subLevels[0].xpRequired;
                let completedLevels = 0;
                
                for (const topic of window.topicsData) {
                    for (const subLevel of topic.subLevels) {
                        if (totalXP >= subLevel.xpRequired) {
                            currentLevel = `${topic.id}.${subLevel.id}`;
                            completedLevels++;
                            if (subLevel !== topic.subLevels[topic.subLevels.length - 1]) {
                                nextLevelXP = topic.subLevels[topic.subLevels.indexOf(subLevel) + 1].xpRequired;
                            }
                        }
                    }
                }
                
                document.getElementById('modalCurrentLevel').textContent = currentLevel;
                document.getElementById('modalCompletedLevels').textContent = completedLevels;
                document.getElementById('modalNextLevel').textContent = 
                    nextLevelXP > totalXP ? 
                    `${nextLevelXP - totalXP} XP needed` : 
                    'Max Level Reached!';
                
                modal.style.display = 'block';
            };

            window.showSettings = function() {
                const modal = document.getElementById('settingsModal');
                modal.style.display = 'block';

                // Initialize settings from localStorage
                document.getElementById('soundToggle').checked = 
                    localStorage.getItem('soundEffects') !== 'false';
                document.getElementById('musicToggle').checked = 
                    localStorage.getItem('backgroundMusic') !== 'false';
                document.getElementById('languageSelect').value = 
                    localStorage.getItem('language') || 'en';
            };

            window.closeModal = function(modalId) {
                document.getElementById(modalId).style.display = 'none';
            };

            // Save settings when changed
            document.getElementById('soundToggle').addEventListener('change', function(e) {
                localStorage.setItem('soundEffects', e.target.checked);
            });

            document.getElementById('musicToggle').addEventListener('change', function(e) {
                localStorage.setItem('backgroundMusic', e.target.checked);
            });

            document.getElementById('languageSelect').addEventListener('change', function(e) {
                localStorage.setItem('language', e.target.value);
            });

            // Close modals when clicking outside
            window.onclick = function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            };

            // Add logout function
            window.logout = function() {
                // Clear user data from localStorage
                localStorage.clear();
                // Redirect to login page
                window.location.href = 'login.html';
            };
        });
    </script>
</body>
</html> 